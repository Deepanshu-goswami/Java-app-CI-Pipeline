pipeline {
    agent any
    tools {
        maven 'maven'
    }
     stages {
        stage('Cloning code from GitHub') {
            steps {
                 git url: 'https://github.com/Deepanshu-goswami/java-app.git' , branch: 'main'
            }
        }
        stage('Application building with Maven') {
            steps {
                // Define steps for the Build stage
                echo 'Building the project...'
                sh 'mvn clean package'
            }
        }
        stage('Code Analysis with Sonarqube') {
           steps{
            script{
               withSonarQubeEnv(installationName: 'sonar-10', credentialsId: 'jenkins')
                {
                  sh 'mvn sonar:sonar'
                }
               
            }
         }
                
        }
    	stage('Building our image with Docker') {
		 steps{                
	        sh 'docker build -t java-application-new:$BUILD_NUMBER .'           
             echo 'Build Image Completed'                
             }
        }
        stage('Image Scanning with Trivy'){
            steps{
                sh 'trivy image java-application-new:$BUILD_NUMBER'
            }
        }
        stage('Image pushing to Google Artifact Registry') {
            steps {
                // Define steps for the image push...
                echo 'Image pushing...'
                sh 'gcloud auth configure-docker \
                    asia-south2-docker.pkg.dev'
                sh'docker tag java-application-new:$BUILD_NUMBER asia-south2-docker.pkg.dev/vishwas-426408/jenkins-repo/java-application-new:$BUILD_NUMBER'
                sh 'docker push asia-south2-docker.pkg.dev/vishwas-426408/jenkins-repo/java-application-new:$BUILD_NUMBER'
                
            }
        }
    }
post{
success {
		mail bcc: '',body: 'Congratulations! Pipeline has been build successfully', cc: '', from: 'deepanshu.goswami95@gmail.com', replyTo: '',subject: 'Jenkins Pipeline Status', to: 'Deepanshu.goswami95@gmail.com'
		}
failure {
		mail bcc: '',body: 'Oops! Your Pipeline is failed. Try again.', cc: '', from: 'deepanshu.goswami95@gmail.com', replyTo: '',subject: 'Jenkins Pipeline Status', to: 'Deepanshu.goswami95@gmail.com'
		}
    }
}
